Let us explore a scenario where you are tasked with taking a point in time backup of the MySQL server that houses a database named world. Within this database, you will encounter tables like cities, countries and languages, each holding data related to cities, countries and languages spoken worldwide.This exercise will build upon the world database created in the previous exercise: Backup and Restore Using MySQL.

Say you have a full logical backup of your whole database in your last mysqldump file as of yesterday evening. However, several changes may have been made (including data loss) since then. Using point-in-time backup and restore, you can get each and every change that occurred since then, so that even after your last logical backup you have a record of all new transactions. Point-in-time backup is the set of binary log files generated subsequent to a logical backup operation of a database. The binary log files contain events that describe database changes such as table creation operations or changes to table data. To restore a database to a point-in-time, you will be using binary log files containing changes of a database for a time interval along with the last logical backup of the database.

Performing Point-in-Time Backup:
Download the required SQL script file in the linux terminal by executing the command below:

wget https://cf-courses-data.s3.us.cloud-object-storage.appdomain.cloud/IBM-DB0231EN-SkillsNetwork/datasets/World/world_mysql_script.sql

wget https://cf-courses-data.s3.us.cloud-object-storage.appdomain.cloud/IBM-DB0231EN-SkillsNetwork/datasets/World/world_mysql_update_A.sql

wget https://cf-courses-data.s3.us.cloud-object-storage.appdomain.cloud/IBM-DB0231EN-SkillsNetwork/datasets/World/world_mysql_update_B.sql

Pre-requisite: To interact with MySQL databases on your local machine, you need to install and start the MySQL server. To install the MySQL server run the following command:

sudo apt-get install mysql-server

This command will prompt you to enter your password, and once you confirm, it will download and install the MySQL server package along with any necessary dependencies.

Note: In case you encounter errors regarding unreachable packages, execute the command sudo apt update to fetch the most recent information concerning available packages and their versions from the repositories set up on your system. Once done you can then execute the command to install the mysql-server.

Start the MySQL service using the command:

sudo systemctl start mysql

This command is used to start the MySQL service on a system running systemd, which is a system and service manager for Linux.

Here's what each part of the command does:

sudo: This prefix grants temporary administrative privileges to the command that follows it. It allows the user to execute the subsequent command with superuser (root) privileges.

systemctl: This is a command-line utility used to manage systemd, which is a system and service manager for Linux operating systems. It allows users to start, stop, enable, disable, and manage services and other units.

start: This subcommand of systemctl instructs systemd to start the specified service. In this case, mysql refers to the MySQL service.

Next, to access the MySQL CLI(Command Line Interface), you can use the command below in the terminal:

sudo mysql -u root -p

Here's what each part of the command does:

mysql: This is the command used to launch the MySQL command-line interface.

-u root: This option specifies the username to use when connecting to the MySQL server. In this case, it specifies that the root user should be used.

-p: This option prompts the user to enter the password for the specified MySQL user (in this case, the root user). After entering the password, if it's correct, the user gains access to the MySQL CLI with administrative privileges.

Create a new database world using the command below in the terminal:

create database world;

To use the newly created world database of previous exercise, use the command below in the terminal:

use world;

Execute the world mysql script (world_mysql.sql) to complete the world database creation process using the command below in the terminal:

source world_mysql_script.sql;

List all the table names from the world database:

SHOW TABLES;

Retrieve all records from the city table where the countrycode is ‘CAN’:

SELECT * FROM city WHERE countrycode='CAN';

You will observe the returned result set is empty set. This means Canada related records are currently absent from the table. Run the update script (world_mysql_update_A.sql) to insert the records you were looking for.


SELECT * FROM city WHERE countrycode='CAN';

Once the operation is completed, we can quit from the MySQL command line interface using the command \q in the terminal.

\q

Next, create a full logical backup of the current state of your whole world database. Use the command below in the terminal (enter your MySQL service session password from the MySQL service session tab if necessary):

sudo mysqldump  --user=root --password --flush-logs --delete-master-logs --databases world > world_mysql_full_backup.sql

Note: The –flush-logs and –delete-master-logs parameters ensure that new binary log files are created after the full backup.

Next, to access the MySQL CLI(Command Line Interface), you can use the command below in the terminal:

sudo mysql -u root -p

To use the already created above world database, use the command below in the terminal:

use world;

List all the table names from the world database:

SHOW TABLES;

Retrieve all records from the city table where the countrycode is ‘CAN’:

SELECT * FROM city WHERE countrycode='CAN';

You will observe the returned result set is empty set. This means Canada related records are currently absent from the table.Run the update script (world_mysql_update_B.sql) to insert the records you were looking for.

source world_mysql_update_B.sql;

Redo the previous step to verify the insertion of Canada-related records:

SELECT * FROM city WHERE countrycode='CAN';

Once the operation is completed, we can quit from the MySQL command line interface using the command \q in the terminal.

\q

Simulate a Database Crash:
Now you will create a scenario where a database crash will be conducted intentionally which will result a significant loss of your world database files.To simulate a database crash and create a scenario for recovery, execute the following commands to stop the MySQL service and remove the database files:

Stop the MySQL service using the following command:

sudo systemctl stop mysql

Here's what each part of the command does:

systemctl: This is a command-line utility used to manage systemd, which is a system and service manager for Linux operating systems. It allows users to start, stop, enable, disable, and manage services and other units.

stop: This subcommand of systemctl instructs systemd to stop the specified service. In this case, mysql refers to the MySQL service.

Remove the world database files using following command:

sudo rm -rf /var/lib/mysql/world

The rm -rf command removes the world directory and all of its contents recursively and forcefully. This includes all the data files, subdirectories, and any other files related to the world database within the MySQL data directory.

Try to retrieve records from any table of the database:

sudo mysql --user=root --password --execute="SELECT * FROM world.city;"

You will face errors since a significant loss of your world database files happened. Now you have to restore the world database along with the updates you made earlier in this exercise running the update script (world_mysql_update_B.sql).

Display the binary logs using the command below in the terminal:

sudo mysql --user=root --password --execute="SHOW BINARY LOGS;"

Write the contents of all binary log files listed above to a single file using the command below in the terminal:

sudo mysqlbinlog /var/lib/mysql/binlog.000003 /var/lib/mysql/binlog.000004 > logfile.sql

Here's what each part of the command does:

Read Binary Log Files: The mysqlbinlog utility reads the specified binary log files (binlog.000003 and binlog.000004).
Convert to SQL Statements: mysqlbinlog converts the binary format of the log files into readable SQL statements. These statements represent the database changes recorded in the logs.
Redirect Output: The SQL statements are redirected and saved into a file named logfile.sql.

Performing Point-in-Time Recovery:
You are ready to perform point-in-time restore. First restore the full logical backup of your whole world database you created earlier in this exercise using the command below in the terminal (enter your MySQL service session password from the MySQL service session tab if necessary):

sudo mysql --user=root --password < world_mysql_full_backup.sql

To verify if you have the updates from the update script (world_mysql_update_B.sql), retrieve all the Canada (countrycode=’CAN’) related records from the city table using the command below in the terminal (enter your MySQL service session password from the MySQL service session tab if necessary):

sudo mysql --user=root --password --execute="SELECT * FROM world.city WHERE countrycode='CAN';"

Now run the logfile you created in step-14 using the command below in the terminal:

sudo mysql --user=root --password < logfile.sql

Redo previous step to verify if you have the updates from the update script (world_mysql_update_B.sql).

sudo mysql --user=root --password --execute="SELECT * FROM world.city WHERE countrycode='CAN';"

Finally through the point-in-time recovery, you have the world database in the same state before you conducted the intentional crash scenario.

Conclusion:
This reading highlights the critical role of Point-in-Time Recovery in database management, providing detailed steps and best practices for performing PITR in MySQL. By mastering these techniques, you can ensure robust data protection and minimize downtime in your database environment.